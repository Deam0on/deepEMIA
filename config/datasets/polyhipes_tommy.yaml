# Dataset-specific configuration for polyhipes_tommy
# Optimized for MAXIMUM detection of both classes (spatial constraints OFF)

metadata:
  name: "polyhipes_tommy"
  description: "Tommy's polyhipes dataset - optimized for maximum detections"
  created: "2025-11-05"
  notes: |
    OPTIMIZATION GOAL: Maximize detections of both Class 0 and Class 1
    Spatial constraints DISABLED for maximum detection
    Very aggressive settings - will detect more but may include false positives
    Enable spatial constraints after to filter invalid detections

# Custom scale bar ROI for this dataset
scale_bar_roi:
  x_start_factor: 0.5
  y_start_factor: 0.005
  width_factor: 0.8
  height_factor: 0.065

# Adjusted for potential edge-close scale bars
scalebar_thresholds:
  intensity: 100               # Lowered from 100 for dimmer scale bars
  proximity: 100              # Increased from 100 for wider spacing
  merge_gap: 15               # Increased from 15 for more merging
  min_line_length: 30         # Reduced from 30 for shorter scale bars
  edge_margin_factor: 0.1    # Reduced from 0.1 for edge-close bars

# Spatial constraints DISABLED for maximum detection
spatial_constraints:
  enabled: true
  
  # Keep rules defined for when you want to enable them
  containment_rules:
    1: 0
  containment_threshold: 0.95
  overlap_rules:
    0:
      allow_overlap: false
      allow_touch: true
      max_iou_threshold: 0.1
    1:
      allow_overlap: true
      allow_touch: true
      max_iou_threshold: 0.9

# Optimized hyperparameters (will be populated by training)
rcnn_hyperparameters:
  best_R50: {}
  best_R101: {}

# AGGRESSIVE inference settings for MAXIMUM detections
inference_overrides:
  inference_settings:
    classes_to_infer: [0]  # null = all classes, or [0, 1] for specific classes

  use_class_specific_inference: true
  confidence_mode: 'manual'  # Use manual to apply our aggressive thresholds
  
  # Aggressive iterative stopping - keep going until we find everything
  iterative_stopping:
    min_total_masks: 50          # Lower threshold to iterate more
    min_relative_increase: 0.05  # Lower from 0.25 - accept smaller improvements
    max_consecutive_zero: 3      # Increased from 1 - try harder
    min_iterations: 5            # Increased from 2 - ensure thorough search
  
  # VERY AGGRESSIVE class-specific detection settings
  class_specific_settings:
    class_0:  # Large particles - AGGRESSIVE
      confidence_threshold: 0.65   # VERY LOW - from 0.5 (will detect uncertain ones)
      iou_threshold: 0.65         # LOWER - from 0.7 (less aggressive NMS merging)
      min_size: 15                # REDUCED from 25 (smaller particles)
      min_size_factor: 0.00005    # REDUCED from 0.0001 (very aggressive)
      use_multiscale: true        # Enable multi-scale for Class 0 too
    
    class_1:  # Small particles - MAXIMUM AGGRESSION
      confidence_threshold: 0.65   # VERY LOW - from 0.3 (detect everything possible)
      iou_threshold: 0.65          # VERY LOW - from 0.5 (minimal NMS merging)
      min_size: 1                 # MINIMUM - from 3 (tiniest particles)
      min_size_factor: 0.000001   # EXTREMELY LOW - from 0.000005
      use_multiscale: true        # Multi-scale detection enabled
  
  # Ensemble for better detection (especially small particles)
  ensemble_settings:
    enabled: true
    small_classes_only: false    # Apply to ALL classes for max detection
    weights:
      R50: 0.50   # Slightly favor R50 for small particles
      R101: 0.50  # R101 for context
  
  # Aggressive tile-based inference
  use_tile_based_inference: true
  
  tile_settings:
    tile_size: 512
    overlap_ratio: 0.15         # Increased from 0.1 for better edge detection
    upscale_factor: 3.5         # Increased from 2.0 for better small particle detection
    edge_filter_enabled: false  # DISABLED - keep all detections including edges
    classes_using_tiling: [0, 1]
    tile_batch_size: 2
