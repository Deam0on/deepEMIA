# Dataset-specific configuration for polyhipes_tommy
# Optimized for balanced detection of both Class 0 and Class 1

metadata:
  name: "polyhipes_tommy"
  description: "Tommy's polyhipes dataset - balanced detection for both classes"
  created: "2025-11-06"
  notes: |
    OPTIMIZATION GOAL: Balance detections of Class 0 and Class 1
    Spatial constraints ENABLED to maintain valid relationships
    Class 0 (large particles) and Class 1 (small particles) equally weighted
    Reasonable false positive rate with spatial consistency

# Custom scale bar ROI for this dataset
scale_bar_roi:
  x_start_factor: 0.5
  y_start_factor: 0.005
  width_factor: 0.8
  height_factor: 0.065

# Standard scalebar thresholds
scalebar_thresholds:
  intensity: 100
  proximity: 100
  merge_gap: 15
  min_line_length: 30
  edge_margin_factor: 0.1

# Spatial constraints ENABLED for valid detection relationships
spatial_constraints:
  enabled: true  # ENABLED for realistic detection relationships
  
  # Class 1 should be contained within Class 0
  containment_rules:
    1: 0
  containment_threshold: 0.95    # 95% overlap required for containment
  
  overlap_rules:
    0:  # Class 0 (large particles)
      allow_overlap: false       # Class 0 instances should not overlap
      allow_touch: true          # But touching is allowed
      max_iou_threshold: 0.05    # Maximum 5% IoU tolerance
    1:  # Class 1 (small particles)
      allow_overlap: false       # Class 1 instances should not overlap with each other
      allow_touch: true          # But touching is allowed
      max_iou_threshold: 0.05    # Maximum 5% IoU tolerance

# Optimized hyperparameters (will be populated by training)
rcnn_hyperparameters:
  best_R50: {}
  best_R101: {}

# BALANCED inference settings for both classes
inference_overrides:
  inference_settings:
    classes_to_infer: null  # null = infer all classes [0, 1]

  use_class_specific_inference: true
  confidence_mode: 'manual'  # Use manual for class-specific control
  
  # Moderate iterative stopping - balance recall and precision
  iterative_stopping:
    min_total_masks: 40          # MODERATE - balance detection count
    min_relative_increase: 0.05  # MODERATE - standard improvement threshold
    max_consecutive_zero: 3      # MODERATE - standard search limit
    min_iterations: 5            # MODERATE - standard search iterations
  
  # BALANCED class-specific detection settings
  class_specific_settings:
    class_0:  # Large particles - BALANCED
      confidence_threshold: 0.60  # MODERATE - balanced precision/recall
      iou_threshold: 0.75         # MODERATE - standard NMS merging
      min_size: 25                # MODERATE - filter obvious noise
      min_size_factor: 0.00005    # MODERATE - realistic size threshold
      use_multiscale: true        # Enable multi-scale detection
    
    class_1:  # Small particles - BALANCED
      confidence_threshold: 0.55  # MODERATE - slightly lower for small objects
      iou_threshold: 0.70         # MODERATE - standard NMS merging
      min_size: 3                 # MODERATE - avoid single pixels
      min_size_factor: 0.000005   # MODERATE - realistic minimum size
      use_multiscale: true        # Multi-scale detection enabled
  
  # Ensemble for better overall accuracy
  ensemble_settings:
    enabled: true
    small_classes_only: false    # Apply to all classes
    weights:
      R50: 0.50   # Balance both models equally
      R101: 0.50  # Balance both models equally
  
  # Moderate tile-based inference
  use_tile_based_inference: true
  
  tile_settings:
    tile_size: 512
    overlap_ratio: 0.25          # MODERATE - standard overlap for edge detection
    upscale_factor: 3.5          # MODERATE - standard upscaling
    edge_filter_enabled: true    # ENABLED - filter unreliable edge detections
    classes_using_tiling: [0, 1] # BOTH classes use tiling
    tile_batch_size: 2