# Dataset-specific configuration for polyhipes_tommy
# Optimized for MAXIMUM detection of Class 1 (small particles)

metadata:
  name: "polyhipes_tommy"
  description: "Tommy's polyhipes dataset - optimized for maximum Class 1 detections"
  created: "2025-11-06"
  notes: |
    OPTIMIZATION GOAL: Maximize detections of Class 1 (small particles)
    Class 0 detection is secondary
    Spatial constraints DISABLED for maximum detection
    Very aggressive settings for tiny particles - will detect more but may include false positives
    Enable spatial constraints after to filter invalid detections

# Custom scale bar ROI for this dataset
scale_bar_roi:
  x_start_factor: 0.5
  y_start_factor: 0.005
  width_factor: 0.8
  height_factor: 0.065

# Adjusted for potential edge-close scale bars
scalebar_thresholds:
  intensity: 100
  proximity: 100
  merge_gap: 15
  min_line_length: 30
  edge_margin_factor: 0.1

# Spatial constraints DISABLED for maximum detection
spatial_constraints:
  enabled: false  # DISABLED for pure Class 1 detection
  
  # Keep rules defined for when you want to enable them
  containment_rules:
    1: 0
  containment_threshold: 0.95
  overlap_rules:
    0:
      allow_overlap: false
      allow_touch: true
      max_iou_threshold: 0.1
    1:
      allow_overlap: true
      allow_touch: true
      max_iou_threshold: 0.9

# Optimized hyperparameters (will be populated by training)
rcnn_hyperparameters:
  best_R50: {}
  best_R101: {}

# AGGRESSIVE inference settings for MAXIMUM Class 1 detections
inference_overrides:
  inference_settings:
    classes_to_infer: [1]  # ONLY Class 1

  use_class_specific_inference: true
  confidence_mode: 'manual'  # Use manual to apply our aggressive thresholds
  
  # Extremely aggressive iterative stopping - exhaust all possibilities
  iterative_stopping:
    min_total_masks: 20          # VERY LOW - accept sparse masks to iterate more
    min_relative_increase: 0.01  # EXTREMELY LOW - accept 1% improvements
    max_consecutive_zero: 8      # MAXIMUM - exhaustive search
    min_iterations: 10           # MAXIMUM - ensure absolute exhaustive search
  
  # ULTRA-AGGRESSIVE class-specific detection settings
  class_specific_settings:
    class_0:  # Large particles - DISABLED
      confidence_threshold: 0.99  # EXTREMELY HIGH - almost disabled
      iou_threshold: 0.10         # VERY LOW IOU - almost no merging
      min_size: 10000             # HUGE - filter out almost all
      min_size_factor: 0.5        # VERY HIGH - filter out small detections
      use_multiscale: false       # DISABLED
    
    class_1:  # Small particles - ULTRA-AGGRESSIVE
      confidence_threshold: 0.30  # EXTREMELY LOW - detect everything
      iou_threshold: 0.50         # LOW - minimal NMS merging
      min_size: 1                 # ABSOLUTE MINIMUM - single pixel
      min_size_factor: 0.000001   # ABSOLUTE MINIMUM - pixel-level detection
      use_multiscale: true        # Multi-scale detection across all tiny sizes
  
  # Ensemble for better Class 1 detection accuracy
  ensemble_settings:
    enabled: true
    small_classes_only: true     # FOCUS on small classes (Class 1)
    weights:
      R50: 0.50   # Balance both models
      R101: 0.50  # Balance both models
  
  # Aggressive tile-based inference optimized for small objects
  use_tile_based_inference: true
  
  tile_settings:
    tile_size: 256               # SMALLER tiles - better for tiny particles
    overlap_ratio: 0.50          # VERY HIGH overlap - capture all small objects at edges
    upscale_factor: 6.0          # VERY HIGH upscaling - capture micro details
    edge_filter_enabled: false   # DISABLED - keep all detections including edges
    classes_using_tiling: [1]    # ONLY Class 1 tiling
    tile_batch_size: 4           # Larger batch for small tiles