# Dataset-specific configuration for polyhipes_tommy
# This dataset has nested particles (Class 1 inside Class 0)

metadata:
  name: "polyhipes_tommy"
  description: "Tommy's polyhipes dataset with nested particle structure"
  created: "2025-11-03"
  notes: |
    Class 0: Large particles (containers)
    Class 1: Small particles (must be contained within Class 0)
    Class 0 particles cannot overlap with each other
    Class 1 particles can overlap with each other but must stay inside Class 0

# Custom scale bar ROI for this dataset
scale_bar_roi:
  x_start_factor: 0.5
  y_start_factor: 0.005
  width_factor: 0.8
  height_factor: 0.065

# Use default scalebar thresholds
scalebar_thresholds:
  intensity: 100
  proximity: 100
  merge_gap: 15
  min_line_length: 30
  edge_margin_factor: 0.1

# Spatial constraints are critical for this dataset
spatial_constraints:
  enabled: true
  
  # Class 1 particles MUST be contained within Class 0 particles
  containment_rules:
    1: 0  # Class 1 (child) must be inside Class 0 (parent)
  
  # Require 95% of child to be inside parent
  containment_threshold: 0.95
  
  # Overlap rules per class
  overlap_rules:
    0:  # Class 0 (large particles) rules
      allow_overlap: false      # Cannot overlap with other Class 0 instances
      allow_touch: true         # But can touch (share boundaries)
      max_iou_threshold: 0.1    # Max 10% IoU tolerance for touching
    1:  # Class 1 (small particles) rules
      allow_overlap: true       # Can overlap with other Class 1 instances
      allow_touch: true         # Can touch
      max_iou_threshold: 0.9    # Allow up to 90% overlap between Class 1 particles

# Store optimized hyperparameters after tuning
# These will be populated by the training pipeline
rcnn_hyperparameters:
  best_R50: {}
  best_R101: {}

# Inference settings optimized for nested particles
inference_overrides:
  use_class_specific_inference: true
  confidence_mode: 'auto'
  
  # Iterative stopping criteria
  iterative_stopping:
    min_total_masks: 10
    min_relative_increase: 0.25
    max_consecutive_zero: 1
    min_iterations: 2
  
  # Class-specific detection settings
  class_specific_settings:
    class_0:  # Large particles (containers)
      confidence_threshold: 0.5
      iou_threshold: 0.7
      min_size: 25
      min_size_factor: 0.0001  # 0.01% of image area
    class_1:  # Small particles (nested inside)
      confidence_threshold: 0.3  # Lower threshold for small particles
      iou_threshold: 0.5
      min_size: 3
      min_size_factor: 0.000005  # 0.0005% of image area (very aggressive)
      use_multiscale: true
  
  # Multi-model ensemble for better small particle detection
  ensemble_settings:
    enabled: true
    small_classes_only: true
    weights:
      R50: 0.6   # R50 better for small particles
      R101: 0.4  # R101 better for context
  
  # Tile-based inference for better small particle detection
  use_tile_based_inference: true
  
  tile_settings:
    tile_size: 512
    overlap_ratio: 0.1
    upscale_factor: 2.0       # 2x upscaling for small particles
    edge_filter_enabled: true
    classes_using_tiling: [0, 1]  # Both classes use tiling
    tile_batch_size: 2
