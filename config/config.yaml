# =============================================================================
# deepEMIA Default Configuration
# =============================================================================
# This file contains ONLY default settings used across all datasets.
# Dataset-specific overrides should be placed in config/datasets/<dataset_name>.yaml
# See config/datasets.example/README.md for documentation.

bucket: nn-uct

paths:
  main_script: "~/deepEMIA/main.py"
  split_dir: "~/split_dir"
  category_json: "~/deepEMIA/dataset_info.json"
  eta_file: "~/deepEMIA/config/eta_data.json"
  logs_dir: "~/logs"
  output_dir: "~/deepEMIA/output"
  local_dataset_root: "~"
  dataset_configs_dir: "~/deepEMIA/config/datasets"  # Location for dataset-specific configs

# Default scale bar ROI settings
# Used when no dataset-specific config exists
scale_bar_rois:
  default:
    x_start_factor: 0.7
    y_start_factor: 0.05
    width_factor: 1
    height_factor: 0.05

# Default scale bar detection thresholds
scalebar_thresholds:
  intensity: 100
  proximity: 100
  merge_gap: 15
  min_line_length: 30
  edge_margin_factor: 0.1 

measure_contrast_distribution: false

# Default RCNN hyperparameters
# Used for all datasets when no dataset-specific settings exist
rcnn_hyperparameters:
  default:
    R50:
      base_lr: 0.00025
      ims_per_batch: 2
      warmup_iters: 1000
      gamma: 0.1
      batch_size_per_image: 64
    R101:
      base_lr: 0.00025
      ims_per_batch: 2
      warmup_iters: 1000
      gamma: 0.1
      batch_size_per_image: 64
  # Best hyperparameters placeholder
  # Populated from dataset-specific configs
  best:
    R50: {}
    R101: {}

# Default inference settings
inference_settings:
  use_class_specific_inference: true
  
  # Confidence threshold mode: 'auto' or 'manual'
  confidence_mode: 'auto'
  
  # Iterative stopping criteria
  iterative_stopping:
    min_total_masks: 10
    min_relative_increase: 0.25
    max_consecutive_zero: 1
    min_iterations: 2
  
  # Default class-specific detection settings
  class_specific_settings:
    class_0:  # Large particles
      confidence_threshold: 0.5
      iou_threshold: 0.7
      min_size: 25
      min_size_factor: 0.0001
    class_1:  # Small particles
      confidence_threshold: 0.3
      iou_threshold: 0.5
      min_size: 3
      min_size_factor: 0.000005
      use_multiscale: true
  
  # Multi-model ensemble settings
  ensemble_settings:
    enabled: true
    small_classes_only: true
    weights:
      R50: 0.6
      R101: 0.4
  
  # Multi-scale inference settings
  multiscale_settings:
    baseline_scales: [0.7, 1.0, 1.5, 2.0]
    aggressive_scales: [1.0, 1.5, 2.0, 2.5, 3.0]
    max_scale: 3.0

  # Tile-based inference settings
  use_tile_based_inference: true
  
  tile_settings:
    tile_size: 512
    overlap_ratio: 0.1
    upscale_factor: 2.0
    edge_filter_enabled: true
    classes_using_tiling: [0, 1]
    tile_batch_size: 2

  # Default spatial constraints (disabled by default)
  spatial_constraints:
    default:
      enabled: false

# L4 GPU Performance Optimizations
# Specifically tuned for g2-standard-4 (4 vCPUs, 16GB RAM, 1x NVIDIA L4)
l4_performance_optimizations:
  # Batch processing (conservative for 16GB RAM)
  inference_batch_size: 1
  measurement_batch_size: 3
  
  # Memory management for L4 GPU (22GB VRAM)
  clear_cache_frequency: 3
  clear_cache_after_tiles: true
  max_memory_usage: 0.8
  
  # Threading (optimized for 4 vCPUs)
  max_worker_threads: 3
  enable_parallel_image_loading: true
  enable_parallel_mask_processing: true
  
  # Model optimizations for L4
  use_mixed_precision: true
  enable_gpu_optimizations: true
  optimize_for_inference: true
  
  # I/O optimizations  
  stream_measurements_to_csv: true
  cleanup_individual_masks: true
